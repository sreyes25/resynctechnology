---
const navLinks = [
  { name: "Services", href: "/#services" },
  { name: "Process", href: "/#process" },
  { name: "About", href: "/about" },
  { name: "Contact", href: "/#contact" },
];

// Mobile list excludes Services because it already appears in the accordion
const mobileLinks = navLinks.filter((l) => l.name !== "Services");

const serviceLinks = [
  { name: "Websites", desc: "Fast, clean, SEO-ready", href: "/#services" },
  { name: "App development", desc: "iOS / Web / Full-stack", href: "/#services" },
  { name: "Workflow automation", desc: "Integrations & ops", href: "/#services" },
  { name: "Tech consulting", desc: "Modernize your stack", href: "/#services" },
];
---

<nav class="rt-nav" data-rt-root>
  <div class="rt-shell">
    <!-- Brand -->
    <a href="/" class="rt-brand" aria-label="Resync">
      <img src="/logo.png" alt="Resync" class="rt-logo" />
      <span class="rt-brand-name">Resync Technology</span>
    </a>

    <!-- Desktop links -->
    <div class="rt-desktop">
      {navLinks.map((l) =>
        l.name === "Services" ? (
          <div class="rt-desktop-item rt-has-menu">
            <a href={l.href} class="rt-link rt-has-dropdown" aria-haspopup="true" aria-expanded="false">
              {l.name}
            </a>
            <div class="rt-dropdown" role="menu">
              {serviceLinks.map((s) => (
                <a class="rt-dropdown-item" href={s.href} role="menuitem">
                  <div class="rt-dropdown-title">{s.name}</div>
                  <div class="rt-dropdown-desc">{s.desc}</div>
                </a>
              ))}
            </div>
          </div>
        ) : (
          <div class="rt-desktop-item">
            <a href={l.href} class="rt-link">
              {l.name}
            </a>
          </div>
        )
      )}
    </div>

    <!-- Desktop CTA -->
    <div class="rt-desktop-actions">
      <a href="/#contact" class="rt-cta rt-desktop-cta">Get in touch</a>
    </div>

    <!-- Mobile open button -->
    <button
      class="rt-menu-btn"
      type="button"
      aria-controls="rt-mobile"
      aria-expanded="false"
      aria-label="Open menu"
      data-rt-open
    >
      <span class="rt-burger" aria-hidden="true"></span>
    </button>
  </div>

  <!-- Mobile overlay -->
  <div id="rt-mobile" class="rt-mobile" data-rt-overlay aria-hidden="true">
    <!-- Backdrop button (click anywhere outside to close) -->
    <button class="rt-backdrop" type="button" aria-label="Close menu" data-rt-close></button>

    <!-- Panel -->
    <div class="rt-panel" role="dialog" aria-modal="true" aria-label="Site navigation">
      <!-- Top bar -->
      <div class="rt-mobile-top">
        <a href="/" class="rt-mobile-brand" data-rt-link>
          <img src="/logo.png" alt="Resync Technology" class="rt-logo" />
          <span class="rt-mobile-brand-name">Resync</span>
        </a>

        <div class="rt-mobile-title">Menu</div>

        <button class="rt-x" type="button" aria-label="Close menu" data-rt-close>
          <span aria-hidden="true">×</span>
        </button>
      </div>

      <!-- Body -->
      <div class="rt-mobile-body">
        <div class="rt-mobile-sub">NYC-BASED SOFTWARE &amp; MODERN ENGINEERING</div>

        <!-- Services accordion -->
        <details class="rt-acc">
          <summary class="rt-row">
            <span>Services</span>
            <span class="rt-chevron" aria-hidden="true"></span>
          </summary>

          <div class="rt-acc-inner">
            {serviceLinks.map((s) => (
              <a class="rt-service" href={s.href} data-rt-link>
                <div class="rt-service-title">{s.name}</div>
                <div class="rt-service-desc">{s.desc}</div>
              </a>
            ))}
          </div>
        </details>

        <!-- Main links -->
        <div class="rt-links">
          {mobileLinks.map((l) => (
            <a class="rt-row rt-row-link" href={l.href} data-rt-link>
              <span>{l.name}</span>
            </a>
          ))}
        </div>

        <!-- Bottom CTA bar -->
        <div class="rt-mobile-bottom">
          <a class="rt-mobile-primary" href="/#contact" data-rt-link>Start a Project</a>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    (() => {
      const root = document.querySelector("[data-rt-root]");
      if (!root) return;

      // Use the VisualViewport height (when available) so mobile browser toolbars don't cover the bottom
      // of the menu content (notably Chrome iOS). We write a CSS var in px and size the overlay/panel to it.
      const docEl = document.documentElement;

      // Chrome on iOS (CriOS) has known repaint/compositing bugs with backdrop-filter + fixed body.
      // We add a class to apply safer CSS on that browser only.
      const isCriOS = /CriOS/i.test(navigator.userAgent) && /iP(ad|hone|od)/i.test(navigator.userAgent);
      if (isCriOS) docEl.classList.add("rt-crios");
      const setVvh = () => {
        const vv = window.visualViewport;
        if (!vv) {
          docEl.style.removeProperty("--rt-vvh");
          return;
        }
        docEl.style.setProperty("--rt-vvh", `${Math.round(vv.height)}px`);
      };

      setVvh();
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", onResize);
        // window.visualViewport.addEventListener("scroll", setVvh);  // REMOVED for CriOS fix
      }
      window.addEventListener("resize", onResize);

      const openBtn = root.querySelector("[data-rt-open]");
      const overlay = root.querySelector("[data-rt-overlay]");
      if (!openBtn || !overlay) return;

      const closeBtns = overlay.querySelectorAll("[data-rt-close]");
      const mobileBody = overlay.querySelector(".rt-mobile-body");
      const detailsEls = overlay.querySelectorAll("details");

      // Force a repaint on CriOS when expanding/collapsing <details> or after scrolling.
      // This addresses a known Chrome iOS compositing bug where content becomes visually blank but remains clickable.
      const forceRepaint = () => {
        if (!isCriOS) return;
        overlay.classList.add("rt-repaint");
        // Force reflow
        void overlay.offsetHeight;
        requestAnimationFrame(() => {
          overlay.classList.remove("rt-repaint");
        });
      };

      detailsEls.forEach((d) => d.addEventListener("toggle", forceRepaint));
      if (mobileBody) mobileBody.addEventListener("scroll", () => requestAnimationFrame(forceRepaint), { passive: true });
      const linkBtns = overlay.querySelectorAll("[data-rt-link]");

      const lockClass = "rt-nav-open";
      let isOpen = false;

      // close helper for listeners
      const closeMenu = () => setOpen(false);

      // Lock background scroll WITHOUT jumping to top (mobile-safe)
      let savedScrollY = 0;
      const lockScroll = (lock) => {
        if (lock) {
          savedScrollY = window.scrollY || 0;
          document.documentElement.classList.add(lockClass);
          document.body.classList.add(lockClass);
          // Freeze the page at the current scroll position
          document.body.style.position = "fixed";
          document.body.style.top = `-${savedScrollY}px`;
          document.body.style.left = "0";
          document.body.style.right = "0";
          document.body.style.width = "100%";
        } else {
          document.documentElement.classList.remove(lockClass);
          document.body.classList.remove(lockClass);
          // Unfreeze and restore scroll position
          document.body.style.position = "";
          document.body.style.top = "";
          document.body.style.left = "";
          document.body.style.right = "";
          document.body.style.width = "";
          window.scrollTo(0, savedScrollY);
        }
      };

      const setOpen = (open) => {
        isOpen = !!open;

        openBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        overlay.setAttribute("aria-hidden", isOpen ? "false" : "true");

        if (isOpen) {
          overlay.classList.add("is-open");
          // CriOS: ensure initial paint is correct
          requestAnimationFrame(forceRepaint);
          lockScroll(true);
        } else {
          overlay.classList.remove("is-open");
          lockScroll(false);
        }
      };

      // Responsive handler (setVvh + close on desktop)
      function onResize() {
        setVvh();
        if (window.innerWidth >= 768 && isOpen) setOpen(false);
      }

      // open
      openBtn.addEventListener("click", () => {
        setVvh();
        setOpen(true);
      });

      // close buttons (X + backdrop)
      closeBtns.forEach((b) => b.addEventListener("click", closeMenu));

      // close on any navigation click
      linkBtns.forEach((a) => a.addEventListener("click", closeMenu));

      // close on ESC
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") setOpen(false);
      });

      // close on resize to desktop
      window.addEventListener("resize", onResize);
    })();
  </script>

  <style>

    :global(:root){
      --rt-vvh: 100dvh;
    }

    /* ===== Desktop bar ===== */
    .rt-nav{
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 9990;
      background: linear-gradient(180deg, rgba(8,8,12,0.92), rgba(8,8,12,0.78));
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 18px 50px rgba(0,0,0,0.22);
    }

    .rt-shell{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 18px;
      height: 72px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 18px;
    }

    .rt-desktop-actions{
      display: none;
      align-items: center;
      gap: 12px;
      justify-self: end;
    }

    .rt-brand{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: rgba(255,255,255,0.94);
      min-width: 0;
    }

    .rt-logo{
      height: 30px;
      width: auto;
      flex: 0 0 auto;
    }

    .rt-brand-name{
      font-weight: 800;
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .rt-desktop{
      display: none;
      align-items: center;
      justify-content: center;
      gap: 26px;
      justify-self: center;
    }

    .rt-desktop-item{
      position: relative;
    }

    .rt-link{
      color: rgba(255,255,255,0.82);
      text-decoration: none;
      font-weight: 650;
      font-size: 15px;
      letter-spacing: 0.005em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: color 160ms ease;
      position: relative;
    }
    .rt-link::after{
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -10px;
      height: 2px;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.5), rgba(255,255,255,0));
      opacity: 0;
      transition: opacity 180ms ease;
    }
    .rt-link:hover{
      color: rgba(255,255,255,1);
    }
    .rt-link:hover::after{
      opacity: 1;
    }
    .rt-link.rt-has-dropdown::before{
      content: "▾";
      font-size: 12px;
      opacity: 0.75;
      margin-right: 4px;
    }

    /* Desktop dropdown */
    .rt-dropdown{
      position: absolute;
      left: 50%;
      top: calc(100% + 12px);
      transform: translateX(-50%) translateY(6px);
      min-width: 280px;
      max-width: 340px;
      padding: 12px;
      background: linear-gradient(180deg, rgba(12,12,16,0.98), rgba(8,8,10,0.96));
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow:
        0 26px 60px rgba(0,0,0,0.5),
        0 6px 18px rgba(0,0,0,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 140ms ease, transform 140ms ease;
      z-index: 10000;
    }
    .rt-dropdown::before{
      content: "";
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 14px; height: 14px;
      background: inherit;
      border-left: 1px solid rgba(255,255,255,0.10);
      border-top: 1px solid rgba(255,255,255,0.10);
      transform-origin: center;
      rotate: 45deg;
      z-index: -1;
    }
    .rt-desktop-item.rt-has-menu:hover .rt-dropdown,
    .rt-desktop-item.rt-has-menu:focus-within .rt-dropdown{
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }
    .rt-dropdown-item{
      display: block;
      padding: 12px 12px 12px 14px;
      border-radius: 12px;
      text-decoration: none;
      color: rgba(255,255,255,0.88);
      transition: background 120ms ease, color 120ms ease, transform 120ms ease;
    }
    .rt-dropdown-item:hover{
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,1);
      transform: translateX(2px);
    }
    .rt-dropdown-title{
      font-weight: 760;
      font-size: 15px;
      letter-spacing: -0.01em;
    }
    .rt-dropdown-desc{
      margin-top: 4px;
      color: rgba(255,255,255,0.64);
      font-size: 13px;
      letter-spacing: 0.01em;
    }

    /* ===== Desktop CTA (pill / glass) ===== */
    .rt-cta{
      position: relative;
      padding: 12px 28px;
      border-radius: 999px;
      color: rgba(255,255,255,0.96);
      font-weight: 800;
      letter-spacing: 0.01em;
      text-decoration: none;

      background: linear-gradient(180deg, rgba(46,50,60,0.92), rgba(22,24,30,0.92));
      border: 1px solid rgba(255,255,255,0.18);

      box-shadow:
        0 18px 50px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.20),
        inset 0 -14px 26px rgba(0,0,0,0.35);

      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);

      transition: transform 140ms ease, box-shadow 180ms ease, border-color 180ms ease, background 180ms ease;
      overflow: hidden;
      isolation: isolate;
    }

    /* subtle outer glow + top rim */
    .rt-cta::before{
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 999px;
      pointer-events: none;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.18),
        0 0 0 1px rgba(255,255,255,0.06);
      opacity: 1;
    }

    /* soft highlight sweep */
    .rt-cta::after{
      content: "";
      position: absolute;
      left: -30%;
      top: -60%;
      width: 160%;
      height: 140%;
      border-radius: 999px;
      background: radial-gradient(closest-side, rgba(255,255,255,0.12), rgba(255,255,255,0));
      transform: translateY(10px);
      opacity: 0.65;
      pointer-events: none;
      transition: opacity 180ms ease, transform 180ms ease;
    }

    .rt-cta:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.24);
      background: linear-gradient(180deg, rgba(56,60,72,0.92), rgba(22,24,30,0.92));
      box-shadow:
        0 22px 60px rgba(0,0,0,0.52),
        inset 0 1px 0 rgba(255,255,255,0.22),
        inset 0 -16px 30px rgba(0,0,0,0.38);
    }

    .rt-cta:hover::after{
      opacity: 0.85;
      transform: translateY(0);
    }

    .rt-cta:active{
      transform: translateY(0px);
      box-shadow:
        0 16px 40px rgba(0,0,0,0.45),
        inset 0 2px 10px rgba(0,0,0,0.35),
        inset 0 -10px 22px rgba(0,0,0,0.30);
    }
    .rt-menu-btn{
      display: inline-flex;
      width: 44px; height: 44px;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.25);
      color: white;
      cursor: pointer;
      justify-self: end;
    }

    .rt-burger{
      width: 18px; height: 2px;
      background: currentColor;
      border-radius: 999px;
      position: relative;
      display: block;
    }
    .rt-burger::before,
    .rt-burger::after{
      content: "";
      position: absolute;
      left: 0;
      width: 18px; height: 2px;
      background: currentColor;
      border-radius: 999px;
    }
    .rt-burger::before{ top: -6px; }
    .rt-burger::after{ top: 6px; }

    @media (min-width: 768px){
      .rt-desktop{ display: flex; }
      .rt-desktop-actions{ display: inline-flex; }
      .rt-desktop-cta{ display: inline-flex; }
      .rt-menu-btn{ display: none; }
    }

    /* Hide desktop CTA block on mobile */
    @media (max-width: 767px){
      .rt-desktop-actions,
      .rt-desktop-cta{
        display: none;
      }
    }

    /* ===== Scroll lock ===== */
    :global(html.rt-nav-open){
      /* prevent scroll chaining on iOS/Chrome while menu is open */
      overscroll-behavior: none;
      touch-action: none;
    }

    :global(body.rt-nav-open){
      /* body is fixed via JS to preserve scroll position */
      overscroll-behavior: none;
      touch-action: none;
    }

    /* Chrome iOS repaint fix: avoid backdrop-filter on overlay layers */
    :global(html.rt-crios) .rt-mobile,
    :global(html.rt-crios) .rt-mobile-top,
    :global(html.rt-crios) .rt-mobile-bottom{
      -webkit-backdrop-filter: none !important;
      backdrop-filter: none !important;
    }

    /* CriOS repaint nudge: toggle this class briefly to force a composite repaint */
    .rt-mobile.rt-repaint{
      transform: translateY(0) translateZ(0);
    }

    /* CriOS: momentum scrolling + fixed body + blur can cause blank paints; use safer scrolling */
    :global(html.rt-crios) .rt-mobile-body{
      -webkit-overflow-scrolling: auto;
    }

    /* CriOS: sticky inside fixed overlays can trigger blank paints; use non-sticky header */
    :global(html.rt-crios) .rt-mobile-top{
      position: relative;
    }

    /* ===== Mobile overlay ===== */
    .rt-mobile{
      position: fixed;
      inset: 0;
      height: var(--rt-vvh, 100dvh);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      background: rgba(3,3,5,0.96);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      isolation: isolate;
      opacity: 0;
      transform: translateY(-8px);
      pointer-events: none;
      transition: opacity 180ms ease, transform 180ms ease;
      will-change: opacity, transform;
    }

    .rt-mobile.is-open{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* solid black full-screen background (the “invertase” effect) */
    .rt-backdrop{
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.92);
      border: 0;
      padding: 0;
      margin: 0;
      cursor: pointer;
      z-index: 0;
    }

    /* panel sits above backdrop */
    .rt-panel{
      position: relative;
      height: 100%;
      min-height: var(--rt-vvh, 100dvh);
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      color: rgba(255,255,255,0.92);
      display: flex;
      flex-direction: column;
      z-index: 1;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .rt-mobile-top{
      position: sticky;
      top: 0;
      z-index: 10;

      padding: max(10px, env(safe-area-inset-top)) 14px 10px;
      background: rgba(0,0,0,0.92);
      border-bottom: 1px solid rgba(255,255,255,0.10);

      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
    }

    .rt-mobile-brand{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: rgba(255,255,255,0.92);
      min-width: 0;
    }

    .rt-mobile-brand-name{
      font-weight: 850;
      letter-spacing: 0.12em;
      font-size: 12px;
      text-transform: uppercase;
      opacity: 0.9;
      white-space: nowrap;
    }

    .rt-mobile-title{
      justify-self: center;
      font-size: 18px;
      font-weight: 650;
      letter-spacing: -0.01em;
      opacity: 0.92;
    }

    .rt-x{
      justify-self: end;
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      font-size: 28px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .rt-mobile-body{
      padding: 14px 16px calc(env(safe-area-inset-bottom) + 24px);
      max-width: 760px;
      margin: 0 auto;
      width: 100%;

      flex: 1 1 auto;
      min-height: calc(var(--rt-vvh, 100dvh) - 84px);

      overflow-y: auto;
      -webkit-overflow-scrolling: touch;

      background: linear-gradient(180deg, rgba(6,6,8,0.99), rgba(6,6,8,0.94));

      display: flex;
      flex-direction: column;
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .rt-mobile-sub{
      color: rgba(225, 29, 72, 0.85);
      font-weight: 850;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 12px;
      margin: 10px 0 14px;
    }

    .rt-row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 0;
      border-top: 1px solid rgba(255,255,255,0.10);
      font-size: 20px;
      text-decoration: none;
      color: rgba(255,255,255,0.90);
    }

    .rt-row-link:hover{ color: rgba(255,255,255,1); }


    /* Accordion */
    .rt-acc{
      border-top: 1px solid rgba(255,255,255,0.10);
    }
    .rt-acc summary{
      list-style: none;
      cursor: pointer;
    }
    .rt-acc summary::-webkit-details-marker{ display: none; }

    .rt-chevron{
      width: 10px; height: 10px;
      border-right: 2px solid rgba(255,255,255,0.55);
      border-bottom: 2px solid rgba(255,255,255,0.55);
      transform: rotate(45deg);
      transition: transform 160ms ease;
      margin-right: 6px;
    }
    details[open] .rt-chevron{
      transform: rotate(-135deg);
    }

    .rt-acc-inner{
      padding: 6px 0 6px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }

    .rt-service{
      display: block;
      padding: 14px 0;
      text-decoration: none;
      color: rgba(255,255,255,0.90);
    }
    .rt-service-title{
      font-weight: 750;
      font-size: 18px;
      letter-spacing: -0.01em;
    }
    .rt-service-desc{
      margin-top: 4px;
      color: rgba(255,255,255,0.55);
      font-size: 14px;
    }

    /* Bottom CTA bar */
    .rt-mobile-bottom{
      position: relative;
      left: auto;
      bottom: auto;
      transform: none;

      width: 100%;
      margin-top: auto;

      padding: 14px 0 calc(env(safe-area-inset-bottom) + 18px);
      background: linear-gradient(180deg, rgba(9,9,12,0.50), rgba(5,5,8,0.70));
      border-top: 1px solid rgba(255,255,255,0.12);

      display: grid;
      gap: 10px;

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .rt-mobile-primary{
      display: block;
      text-align: center;
      padding: 14px 16px;
      border-radius: 999px;
      background: linear-gradient(135deg, #7a0a1f, #e11d48 45%, #ff5670 60%, #b50f2f);
      box-shadow:
        inset 0 2px 8px rgba(255,255,255,0.16),
        inset 0 -6px 12px rgba(0,0,0,0.3),
        0 10px 28px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.08);
      color: white;
      font-weight: 900;
      letter-spacing: 0.01em;
      text-decoration: none;
      transition: transform 120ms ease, box-shadow 160ms ease;
    }
    .rt-mobile-primary:active{
      transform: translateY(1px);
      box-shadow:
        inset 0 2px 10px rgba(0,0,0,0.45),
        0 8px 20px rgba(0,0,0,0.35);
    }

  </style>
</nav>
